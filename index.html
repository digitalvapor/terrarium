<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>My Carnivorous Plant Terrarium</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/2.1.1/css/bootstrap.min.css">
</head>
<body>

    <div class="container">
        <h1>My Carnivorous Plant Terrarium</h1>
        <hr />
        <div id="plot_container" style="min-width: 400px; height: 400px; margin: 0 auto"></div>
        <div class="page"></div>

        <div id='plant_container'>
            <button type="submit" id="load_plants" class="btn btn-primary">Load Plant Data</button>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.4.2/underscore-min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.1.2/backbone-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/4.0.4/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/4.0.4/modules/exporting.js"></script>
    <script src="js/plot.js" type="text/javascript"></script>

    <script>
        function display_plants(plant_json){
            // Given json data of the plants.
            // Displays a table of the parsed data.
            // Returns nothing.

            var table = '<table id="plant_list" class="table table-striped">';
            table += '<tr><th rowspan="2"></th><th rowspan="2">Name</th><th rowspan="2">Common Name</th><th colspan="3""><center>Limits<a href="#limit_note" name="plant_list_top">*</a></center></th><th rowspan="2">Sources</th></tr>';
            table += '<th>Temp</th><th>Hum</th><th>Lum</th>';
            $.each(plant_json, function(i, p){
                // format sources
                var sources = '';
                $.each(p['sources'], function(i, src){
                    if(i) sources += ', ';
                    sources += '<a href="' + src[1] + '">' + src[0] + '</a>';
                });
                // format temperatures
                var temps = '';
                $.each(p['t'], function(i, t){
                    if(t === undefined)
                        return;
                    if(i) temps += ', ';
                    if($.isArray(t)){
                        $.each(t, function(j, t_pt){
                            if(t_pt == null)
                                t[j] = '<span style="color: #777;">' + t_pt + '</span>';
                        });
                        temps += t[0] + ' to ' + t[1];
                    }
                    else
                        temps += t;
                });
                // format humidity
                // var hums = '';
                // $.each(p['h'], function(i, h){
                //     if(h === null || h === undefined)
                //         return;
                //     else
                //         hums += h[0] + ' to ' + h[1];
                // });
                // make table row
                var $tr = $('<tr>').append( // small workaround
                    $('<td>').text(i),
                    $('<td>').html('<i>' + p['name'] + '</i>'),
                    $('<td>').text(p['common_name']),
                    //$('<td>').text(p['t']),
                    $('<td>').html(temps),
                    $('<td>').text(p['h']),
                    //$('<td>').html(hums),
                    $('<td>').text(p['l']),
                    //$('<td>').text(p['sources'])
                    $('<td>').html(sources)
                );
                table += '<tr>' + $tr.html() + '</tr>';
            });
            table += '</table>';
            table += '<p><a name="limit_note" href="#plant_list_top">*</a> Temp is lower/higher ambient temperature. Some plants such as <i>Darlingtonia californica</i> need a different soil temperature than ambient temperature. In these cases it is soil temp and then ambient temp. A third temperature field is if extremes are mentioned. Humidity is lower/higher humidity. Luminosity is for the moment just the number of hours of light needed. When I find more literature for lower/upper bounds I will add this; as well as soil moisture, air flow, and pH.</p>';
            $('#plant_container').html(table);
        };

        function get_limits(plant_json){
            // ATM, not considering soil temperature for the limits.
            // Returns lower and upper ambient temperature and humidity.

            var t_max, t_min, h_max, h_min;
            $.each(plant_json, function(i, p){
                if(p['t']){
                    t = p['t'].pop(); // get's last array in temp array, because ignoring soil temp.
                    if(typeof(t) === "string")
                        t = p['t'].pop(); // sometimes I put notes as the last value, pop again if found a string.
                    if(t !== undefined){
                        if($.isNumeric(t[0])){
                            if(t_min === undefined)
                                t_min = t[0]
                            else
                                t_min = Math.max(t_min, t[0]);
                        }
                        if($.isNumeric(t[1]))
                            if(t_max === undefined)
                                t_max = t[1]
                            else
                                t_max = Math.min(t_max, t[1]);
                    }
                }
                if(p['h']){
                    h = p['h'];
                    if(h !== undefined){
                        if($.isNumeric(h[0])){
                            if(h_min === undefined)
                                h_min = h[0]
                            else
                                h_min = Math.max(h_min, h[0]);
                        }
                        if($.isNumeric(h[1]))
                            if(h_max === undefined)
                                h_max = h[1]
                            else
                                h_max = Math.min(h_max, h[1]);
                    }
                }

            });
            return [[t_min, t_max], [h_min, h_max]];
        };

        function chart_limits(lims){
            // This function plots the limits obtained from the plant.json data.
            // Given limits, returns nothing.

            // TODO: LEFT OFF HERE
        };

        $('#load_plants').click(function(){
            // This function, on clicking load data button, loads the plant data
            // from the json file, displays a table of the data, calculates the
            // upper and lower bounds of the limits, and then graphs these
            // limits on the highcharts plot.

            var pd;
            $.ajax({
                url: 'js/plants.json',
                async: false,
                dataType: 'json',
                success: function (data) {
                    pd = data;
                    console.log('Successfully retrieved default plants.')
                },
                error: function(data, error){
                    console.warn('Could not retrieve the default plants: ' + error);
                }
            });

            display_plants(pd);
            var limits = get_limits(pd);
            console.log('Limits retrieved: '+limits);
            chart_limits(limits);
        });
    </script>

    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-44642246-13', 'auto');
    ga('send', 'pageview');

    </script>
</body>
</html>
